/*
Cuckoo Sandbox - Automated Malware Analysis.
Copyright (C) 2016 Cuckoo Foundation.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <stdio.h>
#include <stdint.h>
#include <windows.h>
#include "misc.h"
#include "native.h"

static int addr_in_stack(void *addr)
{
    NT_TIB *tib = (NT_TIB *) readtls(TLS_TEB);
    return addr >= tib->StackLimit && addr < tib->StackBase;
}

// Currently we just check if the memory block is of MEM_PRIVATE type.
// There are some APIs for traversing the heap, but they might miss
// some of the heap blocks (e.g., regions allocated through VirtualAlloc).
static int addr_in_heap(void *addr)
{
    MEMORY_BASIC_INFORMATION_CROSS mbi;
    virtual_query(addr, &mbi);
    return mbi.Type == MEM_PRIVATE;
}

int exploit_is_stack_pivoted()
{
    void *ptr = NULL;
    return addr_in_stack(&ptr) == 0;
}

int exploit_makes_stack_executable(
    HANDLE process_handle, PVOID addr, DWORD new_protection)
{
    return (new_protection & PAGE_EXECUTABLE) != 0 &&
        addr_in_stack(addr) != FALSE &&
        process_handle == get_current_process();
}

int exploit_makes_heap_executable(
    HANDLE process_handle, PVOID addr, DWORD new_protection)
{
    return (new_protection & PAGE_EXECUTABLE) != 0 &&
        addr_in_heap(addr) != FALSE &&
        process_handle == get_current_process();
}
