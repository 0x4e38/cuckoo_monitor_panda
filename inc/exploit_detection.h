#ifndef MONITOR_EXPLOIT_DETECTION_H
#define MONITOR_EXPLOIT_DETECTION_H

#include <winnt.h>
#include "native.h"

static inline NT_TIB *get_tib()
{
	NT_TIB *pTib;
	#if !__x86_64__
	__asm__ volatile("movl %%fs:0x18, %0" : "=r" (pTib) : );
	#else
	pTib = (NT_TIB*)NtCurrentTeb();
	#endif
	return pTib;
}

static inline PVOID getStackPointer()
{
    PVOID ret;
	#if !__x86_64__
    __asm__ volatile("movl %%esp, %0" : "=r" (ret));
	#else
	__asm__ volatile("mov %%rsp, %0" : "=r" (ret));
	#endif
    return ret;
}

static DWORD EXECUTE_PROTECTIONS = (PAGE_EXECUTE | PAGE_EXECUTE_READ | PAGE_EXECUTE_READWRITE | PAGE_EXECUTE_WRITECOPY);

BOOL stackPivotDetection();
void getStackBoundaries(PVOID *sb, PVOID *sl);
BOOL isAddressInStack(PVOID addr);
BOOL isAddressInHeap(PVOID addr);
BOOL stackDEPBypass(HANDLE hProcess, PVOID addr, DWORD new_protection);
BOOL heapDEPBypass(HANDLE hProcess, PVOID addr, DWORD new_protection);

#endif